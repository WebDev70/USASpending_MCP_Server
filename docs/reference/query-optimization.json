{
  "version": "1.0",
  "title": "Query Optimization Guide",
  "description": "Performance guidelines, optimization strategies, and best practices for efficient API queries",
  "last_updated": "2025-10-30",
  "query_cost_estimates": {
    "description": "Estimated response time and data size for different query types",
    "estimates": {
      "simple_id_lookup": {
        "endpoint": "/awards/{id}/",
        "typical_response_ms": "45-150",
        "response_size_kb": "5-15",
        "cost_level": "minimal",
        "when_to_use": "When you have exact Award ID"
      },
      "keyword_search_small": {
        "endpoint": "/search/spending_by_award/",
        "parameters": "1-3 keywords, limit <= 10",
        "typical_response_ms": "150-300",
        "response_size_kb": "20-50",
        "cost_level": "low",
        "when_to_use": "Quick searches for specific items"
      },
      "keyword_search_large": {
        "endpoint": "/search/spending_by_award/",
        "parameters": "broad keywords, limit = 100",
        "typical_response_ms": "500-1500",
        "response_size_kb": "200-500",
        "cost_level": "moderate",
        "when_to_use": "Comprehensive searches"
      },
      "state_breakdown": {
        "endpoint": "/search/spending_by_geography/",
        "scope": "state level",
        "typical_response_ms": "200-800",
        "response_size_kb": "30-50",
        "cost_level": "low",
        "when_to_use": "Geographic analysis"
      },
      "trend_analysis": {
        "endpoint": "/search/spending_over_time/",
        "parameters": "fiscal_year grouping, 10 years",
        "typical_response_ms": "300-800",
        "response_size_kb": "5-10",
        "cost_level": "low",
        "when_to_use": "Trend and historical analysis"
      },
      "category_breakdown": {
        "endpoint": "/search/spending_by_category/",
        "parameters": "naics or psc, limit = 100",
        "typical_response_ms": "150-600",
        "response_size_kb": "50-150",
        "cost_level": "moderate",
        "when_to_use": "Industry/PSC analysis"
      },
      "large_search": {
        "endpoint": "/search/spending_by_award/",
        "parameters": "broad filters, limit = 100, pagination",
        "typical_response_ms": "800-2000",
        "response_size_kb": "200-500",
        "cost_level": "high",
        "when_to_use": "Comprehensive dataset extraction"
      }
    }
  },
  "field_selection_impact": {
    "description": "How selecting specific fields impacts response size and speed",
    "principle": "Requesting fewer fields = smaller response = faster parsing",
    "recommendations": {
      "minimal_fields": {
        "fields": ["Award ID", "Recipient Name", "Award Amount"],
        "response_size_reduction": "~50%",
        "use_case": "Quick lookups, summaries"
      },
      "standard_fields": {
        "fields": ["Award ID", "Recipient Name", "Award Amount", "Award Type", "Description"],
        "response_size_reduction": "~30%",
        "use_case": "Most common queries"
      },
      "all_available_fields": {
        "response_size_reduction": "baseline (100%)",
        "use_case": "When you need complete data"
      }
    },
    "optimization_strategy": "Request only fields you actually use. Saves bandwidth and parsing time."
  },
  "date_range_optimization": {
    "principle": "Narrower date ranges = faster queries and better results",
    "strategies": {
      "avoid_default_ranges": {
        "bad": "start_date not specified (defaults to 2007-10-01)",
        "good": "start_date='2024-01-01'",
        "impact": "10x faster for recent data"
      },
      "rolling_window_strategy": {
        "approach": "Query in 90-day windows instead of 5 years at once",
        "example": [
          "Query 2024-01-01 to 2024-03-31",
          "Query 2024-04-01 to 2024-06-30",
          "Query 2024-07-01 to 2024-09-30",
          "Query 2024-10-01 to 2024-12-31"
        ],
        "benefit": "More reliable results, avoids pagination limits"
      },
      "fiscal_year_queries": {
        "approach": "Use fiscal year boundaries",
        "example": {
          "start_date": "2024-10-01",
          "end_date": "2025-09-30",
          "fiscal_year": "2025"
        },
        "benefit": "Cleaner data grouping"
      }
    },
    "recommendations": [
      "Always specify start_date and end_date explicitly",
      "Limit date ranges to <= 1 year for keyword searches",
      "Use fiscal_year grouping for trends (better performance)",
      "For historical data, query in annual chunks",
      "For recent data (< 6 months), queries are fastest"
    ]
  },
  "pagination_strategies": {
    "principle": "USASpending API has 100 result limit per page",
    "when_you_need_pagination": [
      "Search returns 'hasNext': true",
      "Result set exceeds 100 items",
      "You want all results for a query"
    ],
    "efficient_pagination": {
      "strategy_1_sequential": {
        "description": "Request pages sequentially",
        "pros": "Simple, reliable",
        "cons": "Slower for large datasets",
        "code_pattern": "Loop page=1 to N, fetch each"
      },
      "strategy_2_keyset_pagination": {
        "description": "Use last_record_unique_id and last_record_sort_value",
        "pros": "Faster for large datasets, avoids offset issues",
        "cons": "Slightly more complex",
        "code_pattern": "Use last_record values to fetch next batch"
      }
    },
    "best_practices": [
      "Limit search results to max 100 per page",
      "Use pagination only when necessary (hasNext=true)",
      "Space paginated requests >= 100ms apart",
      "Cache results to avoid re-fetching",
      "Consider if you really need all 10,000+ results"
    ]
  },
  "filter_efficiency": {
    "principle": "More specific filters = faster, smaller results",
    "filter_efficiency_ranking": [
      {
        "rank": 1,
        "filter": "Award ID (exact match)",
        "response_time": "45-150ms",
        "results": "1 or 0",
        "best_for": "Lookups you know the ID for"
      },
      {
        "rank": 2,
        "filter": "Agency + Date range",
        "response_time": "150-300ms",
        "results": "100-1000s",
        "best_for": "Agency-specific analysis"
      },
      {
        "rank": 3,
        "filter": "Award Type + Date range",
        "response_time": "200-500ms",
        "results": "1000s-10000s",
        "best_for": "Contract vs grant analysis"
      },
      {
        "rank": 4,
        "filter": "Keywords only (no date range)",
        "response_time": "500-2000ms",
        "results": "10000s-100000s",
        "best_for": "Broad searches (slow!)"
      },
      {
        "rank": 5,
        "filter": "No filters (all spending)",
        "response_time": "1000-5000ms",
        "results": "Millions",
        "best_for": "Aggregation only"
      }
    ]
  },
  "caching_recommendations": {
    "principle": "Avoid repeated queries by caching results",
    "cacheable_data": {
      "reference_tables": {
        "what": "Agency codes, NAICS codes, state codes, award types",
        "cache_duration": "Until project end (very stable)",
        "file_location": "reference-data.json (already cached)",
        "benefit": "Reduce redundant lookups"
      },
      "award_details": {
        "what": "Individual award information",
        "cache_duration": "Until same day (awards updated daily)",
        "cache_key": "award_id",
        "benefit": "Avoid retrieving same award twice"
      },
      "trend_data": {
        "what": "Spending over time results",
        "cache_duration": "Until next day (data updated daily)",
        "cache_key": "period + filters",
        "benefit": "Significant (FY trends rarely change)"
      },
      "geographic_data": {
        "what": "State/county spending breakdowns",
        "cache_duration": "Until next day",
        "cache_key": "geo_layer + scope",
        "benefit": "Moderate"
      }
    },
    "implementation": {
      "simple": "Use in-memory dict or JSON file",
      "robust": "Use Redis or similar for shared cache",
      "best_practice": "Cache API responses, not parsed results (allows format changes)"
    }
  },
  "rate_limiting_handling": {
    "limits": {
      "concurrent_requests": "~10 per IP",
      "spacing_between_requests": ">= 100ms recommended",
      "timeout": "30 seconds per request",
      "burst_limit": "Appears to be enforced"
    },
    "strategies": {
      "proactive_spacing": {
        "approach": "Add 100-200ms delay between requests",
        "implementation": "time.sleep(0.1) between API calls",
        "benefit": "Never hit rate limits"
      },
      "exponential_backoff": {
        "approach": "If 429 error, wait: 1s, 2s, 4s, 8s",
        "implementation": "Retry logic with increasing delays",
        "benefit": "Recovers from temporary overloads"
      },
      "request_batching": {
        "approach": "Batch multiple filters into single query where possible",
        "example": "Query ['A', 'B'] award types at once vs separately",
        "benefit": "Fewer total requests"
      },
      "sequential_not_parallel": {
        "approach": "Query one at a time, not in parallel",
        "why": "Concurrent requests hit limits faster",
        "benefit": "More reliable, fewer 429 errors"
      }
    }
  },
  "specific_optimizations": {
    "fy_trend_queries": {
      "fast_approach": {
        "endpoint": "/search/spending_over_time/",
        "group_by": "fiscal_year",
        "time_range": "Last 20 years (2005-2025)",
        "estimated_time": "300-600ms",
        "result_size": "~10KB",
        "optimization": "Uses minimal API resources, very fast"
      },
      "slow_approach": {
        "endpoint": "/search/spending_by_award/",
        "query": "Group results manually by FY",
        "time_range": "Same",
        "estimated_time": "5000-10000ms",
        "result_size": "500KB+",
        "lesson": "Use aggregation endpoints when available"
      }
    },
    "contractor_search": {
      "fast_approach": [
        "1. Search by keywords (500ms)",
        "2. Get top results, extract recipients",
        "3. Cache recipient spending (from results)"
      ],
      "slow_approach": [
        "1. Get all contractors by PSC (2000ms)",
        "2. Filter manually for keywords",
        "3. Manually calculate spending"
      ]
    },
    "geographic_analysis": {
      "fast": "/search/spending_by_geography/ endpoint (200ms)",
      "slow": "Query awards by state, aggregate manually (5000ms+)"
    }
  },
  "anti_patterns_to_avoid": {
    "querying_all_data": {
      "bad": "Query all awards without filters",
      "why": "Slow (10000+ ms), large response (GB), pagination required",
      "better": "Add date range, agency, or award type filter"
    },
    "redundant_requests": {
      "bad": "Query same award details multiple times in loop",
      "why": "Wastes API quota, slow",
      "better": "Cache results, reuse in loop"
    },
    "broad_keywords": {
      "bad": "Search for 'federal' or 'contract'",
      "why": "Returns 100000s+ results, huge response",
      "better": "Add agency/date filters, use specific keywords"
    },
    "manual_aggregation": {
      "bad": "Query all awards, sum manually in code",
      "why": "API has aggregation endpoints, why duplicate?",
      "better": "Use /spending_by_category/ or /spending_over_time/"
    },
    "concurrent_requests": {
      "bad": "Make 10 requests in parallel",
      "why": "Hits rate limits immediately",
      "better": "Sequential requests with 100ms spacing"
    },
    "ignoring_pagination": {
      "bad": "Request limit=100, assume no more results",
      "why": "May miss data",
      "better": "Check hasNext, fetch pages if needed"
    }
  },
  "benchmarks": {
    "expected_performance": {
      "trending_queries": "< 1 second (typical)",
      "award_search": "< 2 seconds typical (< 5s for broad)",
      "geographic_breakdown": "< 1 second",
      "category_analysis": "< 1 second",
      "large_pagination": "Can take 30+ seconds for 1000s of pages"
    },
    "slow_query_indicators": [
      "Response > 3 seconds → likely too broad filters or pagination",
      "Response > 10 seconds → check for rate limiting, try smaller date range",
      "429 error → too many concurrent requests, add delays"
    ]
  },
  "best_practices_summary": [
    "1. Use aggregation endpoints (/spending_over_time/, /spending_by_category/) for summaries",
    "2. Always specify date ranges explicitly",
    "3. Request only needed fields in search queries",
    "4. Cache results that don't change daily",
    "5. Space requests >= 100ms apart",
    "6. Use sequential queries, not parallel",
    "7. Filter by agency/award type before keywords",
    "8. Paginate only when necessary (hasNext=true)",
    "9. Use keyset pagination for large result sets",
    "10. Implement exponential backoff for rate limit errors"
  ]
}
